<!DOCTYPE html>
<html lang="en">
    {% set title =
        "Articles" ~
        (current_feed_profile and ("[" ~ current_feed_profile ~ "]") or "") ~
        (current_search_term and (" | Search: " ~ current_search_term) or "") ~
        " (Page " ~ page ~ ")"
    %}
    {% include 'head.html' %}

    <body>
        <div class="container">
            {% include 'header.html' %}
            <h2>
                Articles
                {% if current_feed_profile %}<span class="profile-badge">{{ current_feed_profile }}</span>{% endif %}
            </h2>
            {% if total_articles > 0 %}
                <p>
                    Showing articles {{ (page - 1) * per_page + 1 }} - {{ [page * per_page, total_articles] | min }} of {{ total_articles }} total (matching filters).
                </p>
            {% else %}
                <p>No articles found matching the current filters.</p>
            {% endif %}
            <form method="GET"
                  action="{{ url_for("list_articles") }}"
                  class="filter-sort-form">
                <input type="hidden" name="sort_by" value="{{ current_sort_by }}">
                <input type="hidden" name="direction" value="{{ current_direction }}">
                <input type="hidden" name="start_date" value="{{ current_start_date }}">
                <input type="hidden" name="end_date" value="{{ current_end_date }}">
                <input type="hidden" name="preset" value="{{ current_preset }}">
                <div class="form-row form-section">
                    <div class="profile-filter">
                        <label for="feed_profile_select">Profile:</label>
                        <select name="feed_profile"
                                id="feed_profile_select"
                                onchange="this.form.submit()">
                            <option value="" {% if not current_feed_profile %}selected{% endif %}>All Profiles</option>
                            {% for profile in available_profiles %}
                                <option value="{{ profile }}"
                                        {% if current_feed_profile == profile %}selected{% endif %}>
                                    {{ profile }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="search-filter">
                        <input type="search"
                               name="search"
                               id="search_box"
                               placeholder="Search title & content..."
                               value="{{ current_search_term }}">
                        <button type="submit" class="btn btn-search" title="Search">
                            <i class="fas fa-search"></i>
                        </button>
                        {% if current_search_term %}
                            <a href="{{ url_for('list_articles', page=1, sort_by=current_sort_by, direction=current_direction, start_date=current_start_date, end_date=current_end_date, preset=current_preset, feed_profile=current_feed_profile) }}"
                               class="btn btn-clear-search"
                               title="Clear Search"><i class="fas fa-times"></i></a>
                        {% endif %}
                    </div>
                </div>
                <div class="form-section">
                    <button type="button"
                            class="date-filter-toggle"
                            onclick="toggleDateFilters()">
                        Date Filters <span class="toggle-icon"><i class="fas fa-calendar-alt"></i></span>
                    </button>
                    <div id="date-filter-content"
                         class="date-filter-content"
                         style="display: none">
                        <div class="date-inputs">
                            <label for="start_date">From:</label>
                            <input type="date"
                                   id="start_date"
                                   name="start_date"
                                   value="{{ current_start_date }}">
                            <label for="end_date">To:</label>
                            <input type="date"
                                   id="end_date"
                                   name="end_date"
                                   value="{{ current_end_date }}">
                            <button type="submit" class="btn btn-filter"><i class="fas fa-filter"></i> Apply Filters</button>
                            <a href="{{ url_for('list_articles', sort_by=current_sort_by, direction=current_direction, feed_profile=current_feed_profile, search=current_search_term) }}"
                               class="btn btn-clear"><i class="fas fa-times-circle"></i> Clear Dates</a>
                        </div>
                        <div class="preset-buttons">
                            {% set presets = {
                                "yesterday": "Yesterday",
                                "last_week": "Last Week",
                                "last_30d": "Last 30d",
                                "last_3m": "Last 3mo",
                                "last_12m": "Last 12mo"
                            } %}
                            {% for key, label in presets.items() %}
                                <a href="{{ url_for('list_articles', preset=key, sort_by=current_sort_by, direction=current_direction, feed_profile=current_feed_profile, search=current_search_term) }}"
                                   class="btn btn-preset {{ 'active' if current_preset == key else '' }}">{{ label }}</a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="sort-controls form-section">
                    Sort by:
                    {% set sort_fields = {"published_date": "Published Date", "impact_score": "Impact Score"} %}
                    {% for field, label in sort_fields.items() %}
                        {% set is_active = (current_sort_by == field) %}
                        {% set next_direction = 'asc' if (is_active and current_direction == 'desc') else 'desc' %}
                        <a href="{{ url_for('list_articles', page=1, sort_by=field, direction=next_direction, start_date=current_start_date, end_date=current_end_date, preset=current_preset, feed_profile=current_feed_profile, search=current_search_term) }}"
                           class="sort-link {{ 'active' if is_active else '' }}">{{ label }}
                            {% if is_active %}<span class="sort-indicator">{{ '▲' if current_direction == 'asc' else '▼' }}</span>{% endif %}
                        </a>
                    {% endfor %}
                </div>
            </form>
            <ul class="article-list">
                {% for article in articles %}
                    {% include '_article_item.html' %}
                {% endfor %}
            </ul>
            {% if total_pages > 1 %}
                <div class="pagination">
                    {% if page > 1 %}
                        <a href="{{ url_for('list_articles', page=page-1, sort_by=current_sort_by, direction=current_direction, start_date=current_start_date, end_date=current_end_date, preset=current_preset, feed_profile=current_feed_profile, search=current_search_term) }}"
                           class="page-link prev"><i class="fas fa-chevron-left"></i> Previous</a>
                    {% else %}
                        <span class="page-link disabled prev"><i class="fas fa-chevron-left"></i> Previous</span>
                    {% endif %}
                    <span class="page-info">Page {{ page }} of {{ total_pages }}</span>
                    {% if page < total_pages %}
                        <a href="{{ url_for('list_articles', page=page+1, sort_by=current_sort_by, direction=current_direction, start_date=current_start_date, end_date=current_end_date, preset=current_preset, feed_profile=current_feed_profile, search=current_search_term) }}"
                           class="page-link next">Next <i class="fas fa-chevron-right"></i></a>
                    {% else %}
                        <span class="page-link disabled next">Next <i class="fas fa-chevron-right"></i></span>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        <script>
            function toggleDateFilters() {
                var content = document.getElementById('date-filter-content');
                var icon = document.querySelector('.date-filter-toggle .toggle-icon');
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    icon.textContent = '-';
                } else {
                    content.style.display = 'none';
                    icon.textContent = '+';
                }
            }

            async function toggleCollectionsMenu(event, menuId) {
                event.stopPropagation();
                const targetMenu = document.getElementById(menuId);

                // Hide all other open menus
                document.querySelectorAll('.collections-menu').forEach(menu => {
                    if (menu.id !== menuId) {
                        menu.style.display = 'none';
                    }
                });

                const isVisible = targetMenu.style.display === 'block';
                if (isVisible) {
                    targetMenu.style.display = 'none';
                    return;
                }

                targetMenu.style.display = 'block';
                const contentDiv = targetMenu.querySelector('.collections-menu-content');

                if (contentDiv.dataset.loaded) {
                    return; // Already loaded, just show it
                }

                const articleId = menuId.split('-').pop();
                contentDiv.innerHTML = 'Loading...';

                try {
                    const response = await fetch(`/article/${articleId}/collections_status`);
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const data = await response.json();

                    if (data.status === 'ok') {
                        let html = '';
                        if (data.collections && data.collections.length > 0) {
                            data.collections.forEach(c => {
                                const buttonHtml = c.contains
                                    ? `<button class="btn btn-clear btn-remove-from-collection" data-collection-id="${c.id}" data-article-id="${articleId}">Remove</button>`
                                    : `<button class="btn btn-filter btn-add-to-collection" data-collection-id="${c.id}" data-article-id="${articleId}">Add</button>`;
                                html += `<div class="collection-entry" data-collection-id="${c.id}"><span>${c.name}</span><span class="collection-action-button">${buttonHtml}</span></div>`;
                            });
                            html += `<div class="collections-menu-footer"><a href="/collections">Manage Collections</a></div>`;
                        } else {
                            html = `<div>No collections yet. <a href="/collections">Create one</a>.</div>`;
                        }
                        contentDiv.innerHTML = html;
                        contentDiv.dataset.loaded = 'true';
                    } else {
                        throw new Error(data.message || 'Failed to load collections.');
                    }
                } catch (error) {
                    console.error('Error fetching collections:', error);
                    contentDiv.innerHTML = '<div class="error-message">Error loading.</div>';
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                // Initialize date filters if dates are present
                var startDate = document.getElementById('start_date').value;
                var endDate = document.getElementById('end_date').value;
                if (startDate || endDate) {
                    toggleDateFilters();
                }

                // Global click handler for closing menus and handling collection actions
                document.addEventListener('click', async function(event) {
                    const target = event.target;
                    let action = null;

                    if (target.matches('.btn-add-to-collection')) action = 'add';
                    if (target.matches('.btn-remove-from-collection')) action = 'remove';

                    if (action) {
                        event.preventDefault();
                        const collectionId = target.dataset.collectionId;
                        const articleId = target.dataset.articleId;
                        const url = `/collection/${collectionId}/${action}_article`;

                        try {
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                                body: JSON.stringify({ article_id: articleId })
                            });
                            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                            const data = await response.json();

                            if (data.status === 'ok') {
                                const buttonContainer = target.parentElement;
                                const newButton = action === 'add'
                                    ? `<button class="btn btn-clear btn-remove-from-collection" data-collection-id="${collectionId}" data-article-id="${articleId}">Remove</button>`
                                    : `<button class="btn btn-filter btn-add-to-collection" data-collection-id="${collectionId}" data-article-id="${articleId}">Add</button>`;
                                buttonContainer.innerHTML = newButton;
                            } else {
                                throw new Error(data.message || 'Action failed.');
                            }
                        } catch (error) {
                            console.error(`Error with ${action} action:`, error);
                            alert(`Failed to ${action} article.`);
                        }
                    } else if (!target.closest('.collections-menu')) {
                        // Close all menus if click is outside
                        document.querySelectorAll('.collections-menu').forEach(menu => {
                            menu.style.display = 'none';
                        });
                    }
                });
            });
        </script>
    </body>
</html>
